# 动态选路协议

> 在之前讨论了静态选路，在配置接口时，以默认方式生成路由表项（对于直接连接的接口），并通过`route`命令增加表项（通常从系统自引导程序文件），或是通过`icmp`重定向生成表项。动态选路协议，它用于路由器间的通信。主要讨论`RIP`，也即选路信息协议（`Routing Information Protocol`），大多数`TCP/IP`实现都提供这个应用广泛的协议，然后讨论两种新的选路协议，`OSPF`和`BGP`。

## Ping程序

`ping`源于声纳定位操作，`Ping`程序由`Mike Muuss`编写，目的是为了测试另一台主机是否可达。该程序发送一份`ICMP`回显请求报文给主机，并等待返回`ICMP`回显应答。

```shell
madong@spotify-mac tcpip-illustrated-network % ping baidu.com
PING baidu.com (220.181.38.148): 56 data bytes
64 bytes from 220.181.38.148: icmp_seq=0 ttl=54 time=6.529 ms
64 bytes from 220.181.38.148: icmp_seq=1 ttl=54 time=6.244 ms
64 bytes from 220.181.38.148: icmp_seq=2 ttl=54 time=9.084 ms
64 bytes from 220.181.38.148: icmp_seq=3 ttl=54 time=8.209 ms
64 bytes from 220.181.38.148: icmp_seq=4 ttl=54 time=6.460 ms
64 bytes from 220.181.38.148: icmp_seq=5 ttl=54 time=11.701 ms
64 bytes from 220.181.38.148: icmp_seq=6 ttl=54 time=25.534 ms
64 bytes from 220.181.38.148: icmp_seq=7 ttl=54 time=11.240 ms
64 bytes from 220.181.38.148: icmp_seq=8 ttl=54 time=9.126 ms
64 bytes from 220.181.38.148: icmp_seq=9 ttl=54 time=6.612 ms
^C
--- baidu.com ping statistics ---
10 packets transmitted, 10 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 6.244/10.074/25.534/5.483 ms
```

当返回`ICMP`回显应答时，要打印出序列号和`TTL`，并计算往返时间（`TTL`位于`IP`首部中的生存时间字段）。`ping`程序通过在`ICMP`报文数据中的时间值来计算往返时间（用当前时间减去`ICMP`报文中的时间值），即往返时间。

在`ping baidu.com`时，输出的第一行包括目的主机的`IP`地址，尽管指定的是它的名字。这说明名字已经经过解析器被转换成`ip`地址了。通常，第`1`往返时间值要比其它的大，这是由于目的端的硬件地址不在`ARP`高速缓存中的缘故。第一个`RTT`使用的时间`6.529 ms`比第二个反馈`6.244 ms`多了约`0.3ms`。这可能是因为发送`ARP`请求和接收`ARP`应答所花费的时间。

`IP`记录路由选项，`ping`程序提供了查看`IP`记录路由（`RR`）选项的机会，大多数不同版本的`ping`程序都提供了`-R`选项，以提供记录路由的功能，其使得`ping`发出去的`IP`数据报中设置`RR`选项（该`IP`数据报包含`ICMP`回显请求报文）。



## Traceroute程序

由`Van Jacobson`编写的`Traceroute`程序是一个能更深入探索`TCP/IP`协议的方便可用的工具，其可以让我们看到`IP`数据报从一台主机传到另一台主机所经过的路由。在网络中，两份连续的`IP`数据报不一定经过相同的路由。

`Traceroute`程序发送一份`UDP`数据报给目的主机，但它选择一个不可能的值作为`UDP`端口号（大于`30000`），使目的主机的任何一个应用程序都不可能使用该端口。因为，当该数据报到达时，将使目的主机的`UDP`模块产生一份"端口不可达"错误的`ICMP`报文。在`Traceroute`发送报文时会设置其`TTL`字段，用于防止数据报在选路时无休止地在网络中流动。

```shell
madong@spotify-mac tcpip-illustrated-network % traceroute baidu.com
traceroute: Warning: baidu.com has multiple addresses; using 39.156.69.79
traceroute to baidu.com (39.156.69.79), 64 hops max, 52 byte packets
 1  bogon (192.168.1.1)  54.489 ms  1.898 ms  1.541 ms
 2  100.72.0.1 (100.72.0.1)  8.601 ms  6.317 ms  17.621 ms
 3  36.112.253.165 (36.112.253.165)  12.943 ms  11.982 ms  5.304 ms
 4  bj141-152-69.bjtelecom.net (219.141.152.69)  7.171 ms
    bj141-152-73.bjtelecom.net (219.141.152.73)  7.923 ms
    36.112.241.89 (36.112.241.89)  5.571 ms
 5  202.97.17.66 (202.97.17.66)  9.574 ms  9.533 ms
    202.97.17.94 (202.97.17.94)  15.067 ms
 6  * 221.183.66.1 (221.183.66.1)  7.333 ms *
 7  * 221.183.25.113 (221.183.25.113)  16.811 ms *
 8  111.24.2.101 (111.24.2.101)  41.402 ms
    111.24.2.109 (111.24.2.109)  8.035 ms
    111.24.2.101 (111.24.2.101)  8.204 ms
 9  111.24.14.14 (111.24.14.14)  11.267 ms
    111.24.14.6 (111.24.14.6)  12.724 ms
    111.24.14.26 (111.24.14.26)  11.361 ms
10  * 39.156.27.1 (39.156.27.1)  10.652 ms
    39.156.27.5 (39.156.27.5)  11.796 ms
11  39.156.27.1 (39.156.27.1)  10.442 ms
    39.156.27.5 (39.156.27.5)  10.981 ms *
12  * * *
```

输出的第`1`个无标号行给出了目的主机名和其`IP`地址，指出`traceroute`程序最大的`TTL`字段数值为`64`。`52`字节的数据报包含`20	`字节的`IP`首部、`8`字节的`UDP`首部和`24`字节的用户数据，每发送一个数据报就加`1`的序列号。

后面的输出是主机或路由器名以及其`IP`地址，对每个`TTL`值，发送`3`份数据报。每接收到一份`ICMP`报文，就计算并打印出往返时间。如果在`5`秒仍未收到任意一份数据报的响应，则打印一个星号，并发送下一份数据报。

`IP`源站选路选项，源站选路（`soure routing`）的思想是由发送者指定路由，可以采用以下两种形式：

1）严格的源路由选择，发送端指明`IP`数据报所必须采用的确切的路由。如果一个路由器发现源路由所指定的下一个路由不在其直接相连的网络上，那么它就返回一个"源站路由失败"的`ICMP`差错报文。

2）宽松的源站路由，发送端指明了一个数据报经过的`IP`地址清单，但数据报在路由清单上指明的仁义两个地址间可以通过其它路由器。



## IP选路

选路是`IP`最重要的功能之一，在网络系统中存在一个路由守护程序（`daemon`），它一般在系统引导时启动进行维护路由表信息。这部分内容主要用来了解单个`IP`层如何做出路由决策。

`IP`搜索路由表的步骤：1）搜索匹配的主机地址；2）搜索匹配的网络地址；3）搜索默认表项（默认表项一般在路由表中被指定为一个网络表项，其网络号为`0`）。`IP`层进行的选路实际上是一种选路机制，它搜索路由表并决定向哪个网络接口发送分组，这区别于选路策略。

在主机执行`netstat`命令，使用`-r`选项列出路由表，使用`-n`选项以数字格式打印出`IP`地址，而不是打印主机名。

```shell
madong@spotify-mac tcpip-illustrated-network % netstat -rn 
Routing tables

Internet:
Destination        Gateway            Flags        Netif Expire
default            192.168.1.1        UGSc           en0       
127                127.0.0.1          UCS            lo0       
127.0.0.1          127.0.0.1          UH             lo0       
169.254            link#6             UCS            en0      !
192.168.1          link#6             UCS            en0      !
192.168.1.1/32     link#6             UCS            en0      !
192.168.1.1        8c:6d:77:a2:d8:9   UHLWIir        en0   1131
```

对于一个给定的路由器，可以打印出`5`种不同的标志（`flag`）：

`U` 该路由可以使用；

`G` 该路由是到一个网关（路由器），如果没有设置该标志，说明目的地址是直接相连的；

`H` 该路由是一个主机，也就是说，目的地址是一个完整的主机地址。如果没有设置该标志，说明该路由是到一个网络；

`D` 路由是由重定向报文创建的；

`M` 该路由已经被重定向报文修改；

标志`G`区分了间接路由和直接路由，其区别在于，发送直接路由的分组不但具有指明目的端的`IP`地址，还具有其链路层地址。对于间接路由，`IP`数据报链路地址必须为`Gateway`地址，然后由其转发。

`Netif`为`lo0`的为环回接口，没有设置`G`标志，因为该路由不是一个网关。`H`标志说明目的地址（`127.0.0.1`）是一个主机地址，而不是一个网络地址。第一行输出的为默认路由`default`，表明如果在表中没有找到特定的路由，就把分组发送到路由器`192.168.1.1`，利用这一路由表项就可以通过`Internet`路由器访问其它的系统。

路由表的初始化，将可到达的不直接相连主机或网络的路由须以某种方式添加到路由表中。常用的方法是在引导时显式地在初始化文件中运行`route`命令。一些系统允许在某个文件中指定默认路由器，如`/etc/defaultrouter`文件。

```shell
> route add default sun 1
> route add slip bsdi 1
```

当路由器收到一份`IP`数据报但又不能转发时，就要发送一份`ICMP` “主机不可达” 差错报文，把接在路由器`sun`上的拨号`SLIP`链路断开，然后试图通过该`SLIP`链路发送分组给任何指定`sun`为默认路由器的主机。

路由表中`D`标志，表示该路由是被`ICMP`重定向报文创建的。



## 动态选路协议

当相邻路由器之间进行通信，以告知对方每个路由器当前所连接的网络，这时就出现了动态选路。路由器上有一个进程称为路由守护程序（`routing deamon`），它运行选路协议，并与其相邻的一些路由器进行通信。

像`Internet`这样的系统，目前采用了许多不同的选路协议。`Internet`以一组自治系统（`AS`，`Autonomous System`）的方式组织的。每个自治系统可以选择该自治系统中各个路由器之间的选路协议，这种协议我们称之为内部网关协议（`Interior Gateway Protocol`）或域内选路协议（`intradomain routing protocol`）。

`RIP`选路信息协议，它是最广为使用（也是最易受攻击）的选路协议，`RIP`报文包含在`UDP`数据报中，采用这`20`个字节格式的`RIP`报文可以通告多达`25`条路由。

`RIP`协议的工作流程，常用的`UDP`端口号是`520`：

1）初始化，启动一个路由守护程序，它先判断启动了哪些接口，并在每个接口上发送一个请求报文，要求其它路由器发送完整路由表。若网络支持广播的话，这种请求是以广播形式发送的；

2）接收到请求后，路由器就将完整的路由表发送给请求者。否则，就处理请求中的每一个表项：有连接到指明地址的路由，则将度量设置成我们的值，否则将度量置为`16`；

3）接收到响应，使响应生效，可能回更新路由表。可能会增加新表项，对已有的表项进行修改，或将已有的表项删除；

4）定期选路更新，每过`30`秒，所有或部分路由器会将其完整路由表发送给相邻路由器。发送路由表可以是广播形式的（如在以太网上），或是发送点对点链路的其它终点的；

5）触发更新，每当一条路由的度量发生变化时，就对它进行更新。不需要发送完整路由表而只需要发送哪些发生变化的表项；

