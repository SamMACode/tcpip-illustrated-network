# 动态选路协议

> 在之前讨论了静态选路，在配置接口时，以默认方式生成路由表项（对于直接连接的接口），并通过`route`命令增加表项（通常从系统自引导程序文件），或是通过`icmp`重定向生成表项。动态选路协议，它用于路由器间的通信。主要讨论`RIP`，也即选路信息协议（`Routing Information Protocol`），大多数`TCP/IP`实现都提供这个应用广泛的协议，然后讨论两种新的选路协议，`OSPF`和`BGP`。

## Ping程序

`ping`源于声纳定位操作，`Ping`程序由`Mike Muuss`编写，目的是为了测试另一台主机是否可达。该程序发送一份`ICMP`回显请求报文给主机，并等待返回`ICMP`回显应答。

```shell
madong@spotify-mac tcpip-illustrated-network % ping baidu.com
PING baidu.com (220.181.38.148): 56 data bytes
64 bytes from 220.181.38.148: icmp_seq=0 ttl=54 time=6.529 ms
64 bytes from 220.181.38.148: icmp_seq=1 ttl=54 time=6.244 ms
64 bytes from 220.181.38.148: icmp_seq=2 ttl=54 time=9.084 ms
64 bytes from 220.181.38.148: icmp_seq=3 ttl=54 time=8.209 ms
64 bytes from 220.181.38.148: icmp_seq=4 ttl=54 time=6.460 ms
64 bytes from 220.181.38.148: icmp_seq=5 ttl=54 time=11.701 ms
64 bytes from 220.181.38.148: icmp_seq=6 ttl=54 time=25.534 ms
64 bytes from 220.181.38.148: icmp_seq=7 ttl=54 time=11.240 ms
64 bytes from 220.181.38.148: icmp_seq=8 ttl=54 time=9.126 ms
64 bytes from 220.181.38.148: icmp_seq=9 ttl=54 time=6.612 ms
^C
--- baidu.com ping statistics ---
10 packets transmitted, 10 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 6.244/10.074/25.534/5.483 ms
```

当返回`ICMP`回显应答时，要打印出序列号和`TTL`，并计算往返时间（`TTL`位于`IP`首部中的生存时间字段）。`ping`程序通过在`ICMP`报文数据中的时间值来计算往返时间（用当前时间减去`ICMP`报文中的时间值），即往返时间。

在`ping baidu.com`时，输出的第一行包括目的主机的`IP`地址，尽管指定的是它的名字。这说明名字已经经过解析器被转换成`ip`地址了。通常，第`1`往返时间值要比其它的大，这是由于目的端的硬件地址不在`ARP`高速缓存中的缘故。第一个`RTT`使用的时间`6.529 ms`比第二个反馈`6.244 ms`多了约`0.3ms`。这可能是因为发送`ARP`请求和接收`ARP`应答所花费的时间。

`IP`记录路由选项，`ping`程序提供了查看`IP`记录路由（`RR`）选项的机会，大多数不同版本的`ping`程序都提供了`-R`选项，以提供记录路由的功能，其使得`ping`发出去的`IP`数据报中设置`RR`选项（该`IP`数据报包含`ICMP`回显请求报文）。



## Traceroute程序

由`Van Jacobson`编写的`Traceroute`程序是一个能更深入探索`TCP/IP`协议的方便可用的工具，其可以让我们看到`IP`数据报从一台主机传到另一台主机所经过的路由。在网络中，两份连续的`IP`数据报不一定经过相同的路由。

`Traceroute`程序发送一份`UDP`数据报给目的主机，但它选择一个不可能的值作为`UDP`端口号（大于`30000`），使目的主机的任何一个应用程序都不可能使用该端口。因为，当该数据报到达时，将使目的主机的`UDP`模块产生一份"端口不可达"错误的`ICMP`报文。在`Traceroute`发送报文时会设置其`TTL`字段，用于防止数据报在选路时无休止地在网络中流动。

```shell
madong@spotify-mac tcpip-illustrated-network % traceroute baidu.com
traceroute: Warning: baidu.com has multiple addresses; using 39.156.69.79
traceroute to baidu.com (39.156.69.79), 64 hops max, 52 byte packets
 1  bogon (192.168.1.1)  54.489 ms  1.898 ms  1.541 ms
 2  100.72.0.1 (100.72.0.1)  8.601 ms  6.317 ms  17.621 ms
 3  36.112.253.165 (36.112.253.165)  12.943 ms  11.982 ms  5.304 ms
 4  bj141-152-69.bjtelecom.net (219.141.152.69)  7.171 ms
    bj141-152-73.bjtelecom.net (219.141.152.73)  7.923 ms
    36.112.241.89 (36.112.241.89)  5.571 ms
 5  202.97.17.66 (202.97.17.66)  9.574 ms  9.533 ms
    202.97.17.94 (202.97.17.94)  15.067 ms
 6  * 221.183.66.1 (221.183.66.1)  7.333 ms *
 7  * 221.183.25.113 (221.183.25.113)  16.811 ms *
 8  111.24.2.101 (111.24.2.101)  41.402 ms
    111.24.2.109 (111.24.2.109)  8.035 ms
    111.24.2.101 (111.24.2.101)  8.204 ms
 9  111.24.14.14 (111.24.14.14)  11.267 ms
    111.24.14.6 (111.24.14.6)  12.724 ms
    111.24.14.26 (111.24.14.26)  11.361 ms
10  * 39.156.27.1 (39.156.27.1)  10.652 ms
    39.156.27.5 (39.156.27.5)  11.796 ms
11  39.156.27.1 (39.156.27.1)  10.442 ms
    39.156.27.5 (39.156.27.5)  10.981 ms *
12  * * *
```

输出的第`1`个无标号行给出了目的主机名和其`IP`地址，指出`traceroute`程序最大的`TTL`字段数值为`64`。`52`字节的数据报包含`20	`字节的`IP`首部、`8`字节的`UDP`首部和`24`字节的用户数据，每发送一个数据报就加`1`的序列号。

后面的输出是主机或路由器名以及其`IP`地址，对每个`TTL`值，发送`3`份数据报。每接收到一份`ICMP`报文，就计算并打印出往返时间。如果在`5`秒仍未收到任意一份数据报的响应，则打印一个星号，并发送下一份数据报。

`IP`源站选路选项，源站选路（`soure routing`）的思想是由发送者指定路由，可以采用以下两种形式：

1）严格的源路由选择，发送端指明`IP`数据报所必须采用的确切的路由。如果一个路由器发现源路由所指定的下一个路由不在其直接相连的网络上，那么它就返回一个"源站路由失败"的`ICMP`差错报文。

2）宽松的源站路由，发送端指明了一个数据报经过的`IP`地址清单，但数据报在路由清单上指明的仁义两个地址间可以通过其它路由器。



## IP选路

选路是`IP`最重要的功能之一，在网络系统中存在一个路由守护程序（`daemon`），它一般在系统引导时启动进行维护路由表信息。这部分内容主要用来了解单个`IP`层如何做出路由决策。

`IP`搜索路由表的步骤：1）搜索匹配的主机地址；2）搜索匹配的网络地址；3）搜索默认表项（默认表项一般在路由表中被指定为一个网络表项，其网络号为`0`）。`IP`层进行的选路实际上是一种选路机制，它搜索路由表并决定向哪个网络接口发送分组，这区别于选路策略。

在主机执行`netstat`命令，使用`-r`选项列出路由表，使用`-n`选项以数字格式打印出`IP`地址，而不是打印主机名。

```shell
madong@spotify-mac tcpip-illustrated-network % netstat -rn 
Routing tables

Internet:
Destination        Gateway            Flags        Netif Expire
default            192.168.1.1        UGSc           en0       
127                127.0.0.1          UCS            lo0       
127.0.0.1          127.0.0.1          UH             lo0       
169.254            link#6             UCS            en0      !
192.168.1          link#6             UCS            en0      !
192.168.1.1/32     link#6             UCS            en0      !
192.168.1.1        8c:6d:77:a2:d8:9   UHLWIir        en0   1131
```

对于一个给定的路由器，可以打印出`5`种不同的标志（`flag`）：

`U` 该路由可以使用；

`G` 该路由是到一个网关（路由器），如果没有设置该标志，说明目的地址是直接相连的；

`H` 该路由是一个主机，也就是说，目的地址是一个完整的主机地址。如果没有设置该标志，说明该路由是到一个网络；

`D` 路由是由重定向报文创建的；

`M` 该路由已经被重定向报文修改；

标志`G`区分了间接路由和直接路由，其区别在于，发送直接路由的分组不但具有指明目的端的`IP`地址，还具有其链路层地址。对于间接路由，`IP`数据报链路地址必须为`Gateway`地址，然后由其转发。

`Netif`为`lo0`的为环回接口，没有设置`G`标志，因为该路由不是一个网关。`H`标志说明目的地址（`127.0.0.1`）是一个主机地址，而不是一个网络地址。第一行输出的为默认路由`default`，表明如果在表中没有找到特定的路由，就把分组发送到路由器`192.168.1.1`，利用这一路由表项就可以通过`Internet`路由器访问其它的系统。

路由表的初始化，将可到达的不直接相连主机或网络的路由须以某种方式添加到路由表中。常用的方法是在引导时显式地在初始化文件中运行`route`命令。一些系统允许在某个文件中指定默认路由器，如`/etc/defaultrouter`文件。

```shell
> route add default sun 1
> route add slip bsdi 1
```

当路由器收到一份`IP`数据报但又不能转发时，就要发送一份`ICMP` “主机不可达” 差错报文，把接在路由器`sun`上的拨号`SLIP`链路断开，然后试图通过该`SLIP`链路发送分组给任何指定`sun`为默认路由器的主机。

路由表中`D`标志，表示该路由是被`ICMP`重定向报文创建的。



## 动态选路协议

当相邻路由器之间进行通信，以告知对方每个路由器当前所连接的网络，这时就出现了动态选路。路由器上有一个进程称为路由守护程序（`routing deamon`），它运行选路协议，并与其相邻的一些路由器进行通信。

像`Internet`这样的系统，目前采用了许多不同的选路协议。`Internet`以一组自治系统（`AS`，`Autonomous System`）的方式组织的。每个自治系统可以选择该自治系统中各个路由器之间的选路协议，这种协议我们称之为内部网关协议（`Interior Gateway Protocol`）或域内选路协议（`intradomain routing protocol`）。

`RIP`选路信息协议，它是最广为使用（也是最易受攻击）的选路协议，`RIP`报文包含在`UDP`数据报中，采用这`20`个字节格式的`RIP`报文可以通告多达`25`条路由。

`RIP`协议的工作流程，常用的`UDP`端口号是`520`：

1）初始化，启动一个路由守护程序，它先判断启动了哪些接口，并在每个接口上发送一个请求报文，要求其它路由器发送完整路由表。若网络支持广播的话，这种请求是以广播形式发送的；

2）接收到请求后，路由器就将完整的路由表发送给请求者。否则，就处理请求中的每一个表项：有连接到指明地址的路由，则将度量设置成我们的值，否则将度量置为`16`；

3）接收到响应，使响应生效，可能回更新路由表。可能会增加新表项，对已有的表项进行修改，或将已有的表项删除；

4）定期选路更新，每过`30`秒，所有或部分路由器会将其完整路由表发送给相邻路由器。发送路由表可以是广播形式的（如在以太网上），或是发送点对点链路的其它终点的；

5）触发更新，每当一条路由的度量发生变化时，就对它进行更新。不需要发送完整路由表而只需要发送哪些发生变化的表项；

相邻路由器通告它与其它网络路由的跳数为`1`，那么我们与那个网络的度量为`2`，这是因为为了发送报文到该网络，我们必须经过那个路由器。

由于每个路由都发送其路由表给邻站，因此，可以判断在同一个自治系统`AS`内到每个网络的路由。如果在该`AS`内从一个路由到一个网络有多条路由，那么路由器将选择跳数最小的路由，而忽略其它路由（相对路径最短）。

跳数的最大值是`15	`，这意味着`RIP`只能用于在主机间最大跳数值为`15`的`AS`内，度量为`16`表示无路由达到该`IP`地址。

`OSPF`：开放最短路径优先，与采用距离向量的`RIP`协议不同的是，`OSPF`是一个链路状态协议。距离向量的意思是，`RIP`发送的报文包含一个距离向量（跳数）。每个路由器都根据它所接收到邻站的这些距离向量来更新自己的路由表。

在一个链路状态协议中，路由器并不与其邻站交换距离信息。它采用的是每个路由器主动地测试与其邻站相连链路的状态，将这些信息发送给他的其它邻站，而邻站将这些信息在自治系统中传播出去。每个路由器接收这些链路状态信息，并建立起完整的路由表。

从实际来看，链路状态协议总是比距离向量协议收敛更快。收敛的意思是在路由发生变化后，例如在路由器关闭或链路出故障后，可以稳定下来。

`OSPF`与`RIP`（以及其它选路协议）的不同点在于，`OSPF`直接使用`IP`。也就是说，它并不使用`UDP`或`TCP`。对于`IP`首部的`protocol`字段，`OSPF`有其自己的值。



## UDP：用户数据报协议

`UDP`不提供可靠性：它把应用程序传给`IP`层的数据发送出去，但是并不保证它们能到达目的地。应用程序必须关心`IP`数据报的长度，如果它超过网络的`MTU`，那么就要对`IP`数据报进行分片。如果需要，源端到目的端之间的每个网络都要进行分片，并不只是发送端主机连接第一个网络才这样做（路径`MTU`的概念）。

![udp-data-header](./reference-media/udp-data-header.png)

`TCP`和`UDP`用目的端口号来来区分来自`IP`层数据的过程，由于`IP`层已经把`IP`数据报分配给`TCP`或`UDP`（根据`IP`首部中协议字段值）。因此`TCP`端口号由`TCP`来查看，`UDP`端口号由`UDP`来查看，`TCP`端口号与`UDP`端口号是相互独立的。

`UDP`长度字段指的是`UDP`首部和`UDP`数据的字节长度，该字段的最小值为`8`字节（发送一份`0`字节的`UDP`数据报是`ok`），这个`UDP`长度是有冗余的。`IP`数据包长度指的是数据报全长，因此`UDP`数据报长度是全长减去`IP`首部长度。

`UDP`检验和覆盖`UDP`首部和`UDP`数据，回想`IP`首部的检验和，`UDP`的检验和是可选的，而`TCP`的检验和是必需的。当发送端没有计算检验和而接收端检测到检验和有差错，那么`UDP`数据报就要被悄悄地丢弃，不会产生任何`ICMP`差错报文。

**`IP`数据分片**，物理网络层一般要限制每次发送数据帧的最大长度，任何时候`IP`层接收到一份要发送的`IP`数据报时，要判断向本地哪个接口发送数据（选路），并查询该接口获得其`MTU`。`IP`把`MTU`与数据报长度进行比较，如果需要则进行分片。分片可以发生在原始发送端主机上，也可以发生在中间路由器上。

把一份`IP`数据报分片以后，只有到达目的地才进行重新组装。重新组装由目的端`IP`层来完成，其目的是使分片和重新组装过程对运输层是（`TCP`和`UDP`）透明的，`IP`首部中包含的数据为分片和重新组装提供了足够的信息。

对于发送端发送的每份`IP`数据报来说，其标识字段都包含一个唯一值。该值在数据报分片时被复制到每个片中（已经看到用途）。标志字段用其中一个比特来表示“更多的片”。除了最后一片，其它每个组成数据报的片都要把该比特置为`1`。片偏移字段指的是该片偏移原始数据报开始处的位置，另外，当数据报被分片后，每个片的总长度要改为该片的长度值。

不足之处，在数据报分片传输后，即使只丢失一片数据也要重传整个数据报。因为`IP`层本身没有超时重传机制—由更高层来负责超时重传（`TCP`有超时和重传机制，但`UDP`没有。一些`UDP`应用程序本身也执行超时和重传）。

**`ICMP`不可达差错（需要分片）**，发生`ICMP`不可达差错的另一种情况是，当路由器收到一份需要分片的数据报，而在`IP`首部又设置了不分片（`DF`）的标志比特。判断到达目的端路途中最小`MTU`是多少—称作路径`MTU`发现机制。

用`Traceroute`确定路径`MTU`，每次收到`ICMP`“不能分片”差错时就减小分组的长度，如果路由器发送的`ICMP`差错报文是新格式，包含出口的`MTU`，那么就用该`MTU`值来发送，否则就用下一个最小的`MTU`值来发送。



## 广播和多播

广播和多播仅应用于`UDP`，它们对需将豹纹同时传往多个接收者的应用来说十分重要。多播（`multicast`）处于单播和广播之间：数据帧仅传送属于多播组的多个主机。收限的广播地址是`255.255.255.255	`，该地址用于主机配置过程中`ip`数据报的目的地址，此时，主机可能还不知道它所在网络的网络掩码，甚至连它的`ip`地址也不知道。

`IP`多播提供两类服务：1）向多个目的地址传送数据，有许多向多个接受者传送信息的应用：例如交互式会议系统和向多个接收者分发邮件或新闻。2）客户对服务器的请求，例如，无盘工作站需要确定启动引导服务器。目前，这项服务器是通过广播来提供的（如`BOOTP`协议）。

能够接收发送一个特定多播组地址数据的主机集合称为主机组（`host group`）。一个主机组可跨越多个网络，主机组中成员可随时加入或离开主机组。主机组中对主机数量没有限制，同时不属于某一主机组的主机可以向该组发送信息。



## IGMP：Internet组管理协议

介绍用于支持主机和路由器进行多播的`Internet`报管理协议（`IGMP`），它让一个物理网络上的所有系统知道主机当前所在的多播组。正如`ICMP`一样，`IGMP`也被当作`IP`层的一部分。`IGMP`报文通过`IP`数据报进行传输，`IGMP`有固定的报文长度。

`IGMP`协议—加入一个多播组，多播的基础就是一个进程的概念，该进程在一个主机的给定接口上加入一个多播组。这里暗示一个主机通过组地址和接口来识别一个多播组，主机必须保留一个表，此表中包含所有至少含有一个进程的多播组以及多播组中的进程数量。

多播路由器使用`IGMP`报文来记录与该路由器相连网络中组成员的变化情况，使用规则如下：

1）当第一个进程加入一个组时，主机就发送一个`IGMP`报告。如果一个主机的多个进程加入同一组，只发送一个`IGMP`报告；

2）进程离开一个组时，主机不发送`IGMP`报告，即便是组中的最后一个进程离开；

3）多播路由器定时发送`IGMP`查询来了解是否还有任何主机包含有属于多播组的进程，多播路由器必须向每个接口发送一个`IGMP`查询；

4）主机通过发送`IGMP`报告来响应一个`IGMP`查询，对每个至少还包含一个进程的组均要发回`IGMP`报告；

在`IGMP`报告和查询的生存时间（`TTL`）均被设置为`1`，这涉及到`IP`首部的`TTL`字段，一个初始`TTL`为`0`的多播数据报将被限制在同一主机。

```shell
madong@spotify-mac tcpip-illustrated-network % netstat -nia
Name       Mtu   Network       Address            Ipkts Ierrs    Opkts Oerrs  Coll
lo0   16384 <Link#1>                      37543965     0 37543965     0     0
lo0   16384 127           127.0.0.1       37543965     - 37543965     -     -
                        224.0.0.251
                        224.0.0.1
lo0   16384 ::1/128     ::1               37543965     - 37543965     -     -
                        ff02::fb           (refs: 1)
                        ff02::2:ff33:9cc0  (refs: 1)
                        ff01::1            (refs: 1)
                        ff02::1            (refs: 1)
                        ff02::1:ff00:1     (refs: 1)
```





